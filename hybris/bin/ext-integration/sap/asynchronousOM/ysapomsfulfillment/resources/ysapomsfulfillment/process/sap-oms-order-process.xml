<?xml version="1.0" encoding="utf-8"?>
<!-- [y] hybris Platform Copyright (c) 2000-2016 hybris AG All rights reserved. This software is the confidential and proprietary information 
	of hybris ("Confidential Information"). You shall not disclose such Confidential Information and shall use it only in accordance with 
	the terms of the license agreement you entered into with hybris. -->
<process xmlns="http://www.hybris.de/xsd/processdefinition" start="checkSAPOrder" name="sap-oms-order-process"
	processClass="de.hybris.platform.orderprocessing.model.OrderProcessModel">

	<action id="checkSAPOrder" bean="sapOmsCheckOrderAction">
		<transition name="OK" to="checkSAPCustomerReplication" />
		<transition name="OK" to="geocodeShippingAddress" />
		<transition name="NOK" to="error" />
	</action>

	<action id="checkSAPCustomerReplication" bean="sapOmsCheckCustomerReplicationAction">
		<transition name="NOK" to="waitForERPCustomerReplication" />
		<transition name="OK" to="geocodeShippingAddress" />
	</action>
	
	<wait id="waitForERPCustomerReplication" then="geocodeShippingAddress" prependProcessCode="false">
		<event>ERPCustomerReplicationEvent_${process.order.user.customerID}_${process.order.code}</event>
	</wait>

	<action id="geocodeShippingAddress" bean="geocodeShippingAddressAction"> 
		<transition name="OK" to="sourceOrder"/>
	</action>
	
	<action id="sourceOrder" bean="sapOmsSourceOrderAction">
		<transition name="OK" to="sendOrderToErp"/>
	</action>

	<action id="sendOrderToErp" bean="sapOmsSendOrderToDataHubAction">
		<transition name="OK" to="waitForERPConfirmation" />
		<transition name="NOK" to="erpsendingerror" />
	</action>
	
	<wait id="waitForERPConfirmation" then="setConfirmationStatus" prependProcessCode="false">
		<event>ERPOrderConfirmationEvent_${process.order.code}</event>
	</wait>
	 
	<action id="setConfirmationStatus" bean="sapOmsSetConfirmationStatusAction">
		<transition name="OK" to="waitForOrderAction" />
		<transition name="NOK" to="error" />
	</action>

    <wait id="waitForOrderAction" prependProcessCode="true" then="failed">
        <case event="OrderActionEvent">
            <choice id="consignmentProcessEnded" then="setCompletionStatus"/>
        </case>
    </wait>
    
	<action id="setCompletionStatus" bean="sapOmsCheckCompletionStatusAction">
		<transition name="OK" to="success" />
		<transition name="WAIT" to="waitForOrderAction" />
		<transition name="ERROR" to="error" />
	</action>

	<action id="setCancelStatus" bean="sapOmsSetCancelAction">
		<transition name="OK" to="canceled" />
		<transition name="NOK" to="error" />
	</action>

	<end id="erpsendingerror" state="ERROR">Sending to ERP went wrong.</end>
	<end id="error" state="ERROR">Order check failed.</end>
	<end id="failed" state="FAILED">Order failed.</end>
	<end id="canceled" state="SUCCEEDED">Order cancelled.</end>
	<end id="success" state="SUCCEEDED">Order placed. Consignment created.</end>

</process>
